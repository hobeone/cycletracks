{% extends "base.html" %}
{% load extra_filters %}

{% block title %}CycleTracks: Activity {{ activity.name }}{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="http://www.google.com/jsapi?key=ABQIAAAAoU2YDajIyJPdof6GDzJKshRpKIwH9gjHw5l4siVVB7mD23aSXhSHvrtQQCEPRhQENq4B3lk8joMYzQ"></script>
<script type="text/javascript" src="/static/greversegeocoder.js"></script>

<script type="text/javascript">
  google.load("maps", "2.x");
  function handle_point(point, map, element_id) {
    var reverse_gcode = new GReverseGeocoder(map);
    GEvent.addListener(reverse_gcode, "error",
      function() {
        document.getElementById(element_id).innerHTML = "Unable to reverse GeoCode";
      }
    );
    GEvent.addListener(reverse_gcode, "load",
      function(placemark) {
        document.getElementById(element_id).innerHTML = placemark.address;
      }
    );
    reverse_gcode.reverseGeocode(point);
  }

  function initialize() {
    var map = new google.maps.Map2(document.getElementById("map"));
    map.setMapType(G_PHYSICAL_MAP);
    map.setCenter(new google.maps.LatLng(0,0),0);
    var sw = new google.maps.LatLng({{sw}});
    var ne = new google.maps.LatLng({{ne}});
    var bounds = new google.maps.LatLngBounds(sw, ne);
    var mapZoomLevel = map.getBoundsZoomLevel(bounds);
    var mapCenter = bounds.getCenter();
    map.setCenter(mapCenter, mapZoomLevel);

    var polyline1_1 = new google.maps.Polyline.fromEncoded({
      weight: 4,
      opacity: 0.6,
      points: {{pts|safe}},
      levels: {{levs|safe}},
      zoomFactor: 2,
      numLevels: 18
    });
    map.addOverlay(polyline1_1);
    map.addControl(new google.maps.SmallMapControl());

    var start_point = new GLatLng({{ start_lat_lng }});
    var mid_point = new GLatLng({{ mid_lat_lng }});
    var end_point = new GLatLng({{ end_lat_lng }});
    handle_point(start_point, map, 'start_location')
    handle_point(mid_point, map, 'mid_location')
    handle_point(end_point, map, 'end_location')
  }
  google.setOnLoadCallback(initialize);

</script>

<script type="text/javascript" src="/static/jquery.js"></script>
<script type="text/javascript" src="/static/jquery.flot.pack.js"></script>
<script>jQuery.noConflict();</script>


{% endblock %}


{% block content %}
<div id="activity_table">
<table width="100%">
  <tr>
    <td align="left" valign="top" width="50%">
      <table>
        <tr>
          <td>Name:</td>
          <td>
            <span id="editable_name">{{ activity.name }}</span>
            <script type="text/javascript">
              new Ajax.InPlaceEditor('editable_name', '/activity/update/', {
                callback: function(form, value) {
                  return 'activity_id={{activity.key}}&attribute=name&value='+escape(value)
                }
              })
            </script>
          </td>
        </tr>
        <tr>
          <td>Start Time:</td><td>{{ activity.start_time|time_to_offset:user.get_profile.tzoffset }}</td>
        </tr>
        <tr>
          <td>End Time:</td><td>{{ activity.end_time|time_to_offset:user.get_profile.tzoffset }}</td>
        </tr>
        <tr>
          <td>Distance:</td><td>{{ activity.total_meters|meters_to_prefered_distance:user.get_profile.use_imperial }}</td>
        </tr>
        <tr>
          <td>Ascent:</td><td>{{activity.total_ascent|format_meters:user.get_profile.use_imperial}}</td>
        </tr>
        <tr>
          <td>Decent:</td>
          <td>{{activity.total_descent|format_meters:user.get_profile.use_imperial}}</td>
        </tr>

        <tr>
          <td>Rolling Time:</td><td>{{ activity.rolling_time|seconds_to_human_readable }}</td>
        </tr>
        <tr>
          <td>Total Time:</td><td>{{ activity.total_time|seconds_to_human_readable }}</td>
        </tr>
        <tr>
          <td>Speed:</td>
          <td>
            Avg: {{ activity.average_speed|kph_to_prefered_speed:user.get_profile.use_imperial }},
            Max: {{ activity.maximum_speed|kph_to_prefered_speed:user.get_profile.use_imperial }}
           </td>
        </tr>
        <tr>
          <td>Heart Rate:</td><td>Avg: {{ activity.average_bpm }}, Max: {{ activity.maximum_bpm }} BPM</td>
        </tr>
        <tr>
          <td>Cadence:</td><td>Avg: {{ activity.average_cadence }}, Max: {{ activity.maximum_cadence }} RPM</td>
        </tr>
        <tr>
          <td>Calories:</td><td>{{ activity.total_calories|floatformat:"-2" }}</td>
        </tr>
        <tr>
          <td>Start Location:</td><td id="start_location"></td>
        </tr>
        <tr>
          <td>Middle Location:</td><td id="mid_location"></td>
        </tr>
        <tr>
          <td>End Location:</td><td id="end_location"></td>
        </tr>
        <tr>
          <td>Uploaded By:</td><td>{{ activity.parent.user }}</td>
        </tr>
        <tr>
          <td>
            Public:</td>
          <td>
            <span id="public_flag">{{ activity.public }}</span>
            <script type="text/javascript">
              new Ajax.InPlaceCollectionEditor(
                  'public_flag',
                  '/activity/update/',
                  {
                    collection: ['True', 'False'],
                    callback: function(form, value) {
                        return 'activity_id={{activity.key}}&attribute=public&value='+escape(value)
                      }
                    });
            </script>

          </td>
        </tr>
        <tr>
          <td>Comment:</td>
          <td>
            <span id="editable_comment">{{ activity.comment }}</span>
            <script type="text/javascript">
              new Ajax.InPlaceEditor('editable_comment', '/activity/update/', {
                callback: function(form, value) { return 'activity_id={{activity.key}}&attribute=comment&value='+escape(value) }
              })
            </script>
          </td>
        </tr>
      </table>
      <br>
      <br>
      <div id="map" style="width: 400px; height: 400px"></div>
      <div><a href="http://maps.google.com/maps?q={{kml_location}}">Bigger Map</a></div>
    </td>
    <td width="50%">
      Heart Rate (BPM)<br><br>
      <div id="bpm_graph" style="width:500px;height:200px"></div>

      <br>Cadence (RPM)<br><br>
      <div id="cadence_graph" style="width:500px;height:200px"></div>

      <br>Speed (kph)<br><br>
      <div id="speed_graph" style="width:500px;height:200px"></div>

      <br>Altitude (Meters)<br><br>
      <div id="altitude_graph" style="width:500px;height:200px"></div>

<script id="source" language="javascript" type="text/javascript">
  jQuery(function () {
      var datasets = {
        "bpm": {
          label: "Heart Rate",
          data: [{{bpm}}],
          color: 1
        },
        "speed": {
          label: "Speed",
          data: [{{speed}}],
          color: 1
        },
        "cadence": {
          label: "Cadence",
          data: [{{cadence}}],
          color: 1
        },
        "altitude": {
          label: "altitude",
          data: [{{altitude}}],
          color: 1
        },

      };

      var xTicks = [];
      {% for v in times %}
        xTicks.push([{{v.0}},"{{v.1|seconds_to_human_readable}}"]);
      {% endfor %}

      shared_options = {
        legend: { position: 'se' },
        xaxis: {
          tickDecimals: 0,
          ticks: xTicks
        },
        yaxis: {
          ticks: 10,
          min: 0,
        },
      };
      jQuery.plot(jQuery("#bpm_graph"), [datasets['bpm']], shared_options);
      jQuery.plot(jQuery("#cadence_graph"), [datasets['cadence']], shared_options);
      jQuery.plot(jQuery("#speed_graph"), [datasets['speed']], shared_options);
      shared_options.yaxis.min = null;
      jQuery.plot(jQuery("#altitude_graph"), [datasets['altitude']], shared_options);
      });
</script>

    </td>
  </tr>
</table>
</div>
{% endblock %}
