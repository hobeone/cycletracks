function GReverseGeocoder(A){this.map=A;this.gdirections=new GDirections();this.geocoder=new GClientGeocoder();this.lastpoint=null;this.closestonroad=null;this.experimental=false;this.ad="";this.step=10;this.start=1;this.gdirectionsrefine=new GDirections();GEvent.bind(this.gdirections,"error",this,this.handleError);GEvent.bind(this.gdirections,"load",this,this.processDirection);GEvent.bind(this.gdirectionsrefine,"error",this,this.handleError);GEvent.bind(this.gdirectionsrefine,"load",this,this.processDirectionRefine)}GReverseGeocoder.prototype.reverseGeocode=function(A){this.lastpoint=A;this.closestonroad=null;this.gdirections.clear();this.gdirections.loadFromWaypoints([A.toUrlValue(6),A.toUrlValue(6)],{getSteps:true,locale:"GB",getPolyline:true})};GReverseGeocoder.prototype.getStatus=function(){return this.gdirections.getStatus()};GReverseGeocoder.prototype.handleError=function(){GEvent.trigger(this,"error")};GReverseGeocoder.prototype.processDirection=function(){var C=this;if(this.gdirections.getPolyline()!=null){this.closestonroad=this.gdirections.getPolyline().getVertex(0)}if(this.gdirections.getNumRoutes()!=0){var E=this.getStreet(this.gdirections.getGeocode(0).address);var A=new GLatLng(Number(this.lastpoint.lat())-0.01,Number(this.lastpoint.lng())-0.01);var D=new GLatLng(Number(this.lastpoint.lat())+0.01,Number(this.lastpoint.lng())+0.01);var B=new GLatLngBounds(A,D);this.geocoder.setViewport(B);this.geocoder.getLocations(E,function(F){var G=C.getBestMatchingPlacemark(F);if(G!=null){if(C.experimental){C.ad=G.address;C.step=10;C.start=1;C.houseNumberSearch()}else{GEvent.trigger(C,"load",G)}}else{C.handleError()}})}};GReverseGeocoder.prototype.getBestMatchingPlacemark=function(D){if(!D||D.Status.code!=200){return null}var E=-1;var G=1000000;for(var F=0;F<D.Placemark.length;F++){var B=D.Placemark[F];var A=new GLatLng(B.Point.coordinates[1],B.Point.coordinates[0]);var C=this.lastpoint.distanceFrom(A);if(C<G){E=F;G=C}}if(E<0){return null}D.Placemark[E].RequestPoint={coordinates:[this.lastpoint.lng(),this.lastpoint.lat()]};D.Placemark[E].PointOnRoad={coordinates:[this.closestonroad.lng(),this.closestonroad.lat()]};D.Placemark[E].Distance=G;D.Placemark[E].DistanceOnRoad=this.closestonroad.distanceFrom(new GLatLng(D.Placemark[E].Point.coordinates[1],D.Placemark[E].Point.coordinates[0]));return D.Placemark[E]};GReverseGeocoder.prototype.processDirectionRefine=function(){var G=this.gdirectionsrefine.getNumGeocodes();var B=-1;var D=100;for(var C=1;C<G;C++){var A=this.gdirectionsrefine.getGeocode(C);var H=new GLatLng(A.Point.coordinates[1],A.Point.coordinates[0]);if(A.AddressDetails.Accuracy==8){var I=this.lastpoint.distanceFrom(H);if(I<D){B=C;D=I}}}if(B<0){if(this.start+(24*this.step)<2000){this.start=this.start+(25*this.step);this.houseNumberSearch()}else{this.handleError()}}else{if(this.step==1){var E=this.gdirectionsrefine.getGeocode(B);E.RequestPoint={coordinates:[this.lastpoint.lng(),this.lastpoint.lat()]};E.PointOnRoad={coordinates:[this.closestonroad.lng(),this.closestonroad.lat()]};E.Distance=D;E.DistanceOnRoad=this.closestonroad.distanceFrom(new GLatLng(E.Point.coordinates[1],E.Point.coordinates[0]));GEvent.trigger(this,"load",E)}else{var A=this.gdirectionsrefine.getGeocode(B);var F=this.start+(B*this.step);this.start=F-10;this.step=1;this.houseNumberSearch()}}};GReverseGeocoder.prototype.houseNumberSearch=function(){this.gdirectionsrefine.clear();this.gdirectionsrefine.loadFromWaypoints([(""+(this.start+(0*this.step))+" ")+this.ad,(""+(this.start+(1*this.step))+" ")+this.ad,(""+(this.start+(2*this.step))+" ")+this.ad,(""+(this.start+(3*this.step))+" ")+this.ad,(""+(this.start+(4*this.step))+" ")+this.ad,(""+(this.start+(5*this.step))+" ")+this.ad,(""+(this.start+(6*this.step))+" ")+this.ad,(""+(this.start+(7*this.step))+" ")+this.ad,(""+(this.start+(8*this.step))+" ")+this.ad,(""+(this.start+(9*this.step))+" ")+this.ad,(""+(this.start+(10*this.step))+" ")+this.ad,(""+(this.start+(11*this.step))+" ")+this.ad,(""+(this.start+(12*this.step))+" ")+this.ad,(""+(this.start+(13*this.step))+" ")+this.ad,(""+(this.start+(14*this.step))+" ")+this.ad,(""+(this.start+(15*this.step))+" ")+this.ad,(""+(this.start+(16*this.step))+" ")+this.ad,(""+(this.start+(17*this.step))+" ")+this.ad,(""+(this.start+(18*this.step))+" ")+this.ad,(""+(this.start+(19*this.step))+" ")+this.ad,(""+(this.start+(20*this.step))+" ")+this.ad,(""+(this.start+(21*this.step))+" ")+this.ad,(""+(this.start+(22*this.step))+" ")+this.ad,(""+(this.start+(23*this.step))+" ")+this.ad,(""+(this.start+(24*this.step))+" ")+this.ad],{getSteps:true,locale:"GB"})};GReverseGeocoder.prototype.getStreet=function(A){if(A==null){return null}if((A!=null)&&(A.indexOf("/")>0)){A=A.split("/");if(isNaN(A[0].charAt(1))){A=A[0]}else{A=A[1]}}return A};GReverseGeocoder.prototype.setExperimentalHouseNumber=function(A){this.experimental=A};GReverseGeocoder.prototype.getPlacemarkProperty=function(A,B){for(var D in A){if((D==B)){return String(A[D])}else{if(typeof (A[D])=="object"){var C=this.getPlacemarkProperty(A[D],B);if(C!=null){return C}}}}return null};