{% extends "base.html" %}
{% load extra_filters %}

{% block title %}CycleTracks: Activity {{ activity.name }}{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="/static/greversegeocoder.js"></script>
<script type="text/javascript" src="/static/jquery.inplace.pack.js"></script>

<script src="/static/timeplot_ajax/simile-ajax-api.js" type="text/javascript"></script>
<script>
  Timeline_urlPrefix='/static/timeplot_js/';
  Timeline_parameters='bundle=true';
  Timeplot_urlPrefix='/static/timeplot_js/';
  Timeplot_parameters='bundle=true';
  SimileAjax.History['enabled'] = false;
</script>

<script type="text/javascript" src="/static/timeplot_js/timeline-api.js"></script>
<script type="text/javascript" src="/static/timeplot_js/timeplot-api.js"></script>

<script type="text/javascript">
  google.load("maps", "2.x");
  function handle_point(point, map, element_id) {
    var reverse_gcode = new GReverseGeocoder(map);
    GEvent.addListener(reverse_gcode, "error",
      function() {
        document.getElementById(element_id).innerHTML = "Unable to reverse GeoCode";
      }
    );
    GEvent.addListener(reverse_gcode, "load",
      function(placemark) {
        document.getElementById(element_id).innerHTML = placemark.address;
      }
    );
    reverse_gcode.reverseGeocode(point);
  }

  function initialize() {
    var map = new google.maps.Map2(document.getElementById("map"));
    map.setMapType(G_PHYSICAL_MAP);
    map.setCenter(new google.maps.LatLng(0,0),0);
    var sw = new google.maps.LatLng({{sw}});
    var ne = new google.maps.LatLng({{ne}});
    var bounds = new google.maps.LatLngBounds(sw, ne);
    var mapZoomLevel = map.getBoundsZoomLevel(bounds);
    var mapCenter = bounds.getCenter();
    map.setCenter(mapCenter, mapZoomLevel);

    var polyline1_1 = new google.maps.Polyline.fromEncoded({
      weight: 4,
      opacity: 0.6,
      points: {{pts|safe}},
      levels: {{levs|safe}},
      zoomFactor: 2,
      numLevels: 18
    });
    map.addOverlay(polyline1_1);
    map.addControl(new google.maps.SmallMapControl());

    var start_point = new GLatLng({{ start_lat_lng }});
    var mid_point = new GLatLng({{ mid_lat_lng }});
    var end_point = new GLatLng({{ end_lat_lng }});
    handle_point(start_point, map, 'start_location')
    handle_point(mid_point, map, 'mid_location')
    handle_point(end_point, map, 'end_location')
  }
  google.setOnLoadCallback(initialize);
</script>

{% endblock %}


{% block extra_body %}
onload="onLoad();" onresize="onResize();"
{% endblock %}

{% block content %}
<div id="activity_table">
<table width="100%">
  <tr>
    <td align="left" valign="top" width="50%">
      <table>
        <tr>
          <td>Name:</td>
          <td>
            <span id="editable_name">{{ activity.name }}</span>
            <script type="text/javascript">
              $("#editable_name").editInPlace({
                url: "/activity/update/",
                params: "ajax=yes",
                value_required: true,
                params: "activity_id={{activity.key}}&attribute=name"
              });
            </script>
          </td>
        </tr>
        <tr>
          <td>Start Time:</td><td>{{ activity.start_time|time_to_offset:user.get_profile.tzoffset }}</td>
        </tr>
        <tr>
          <td>End Time:</td><td>{{ activity.end_time|time_to_offset:user.get_profile.tzoffset }}</td>
        </tr>
        <tr>
          <td>Distance:</td><td>{{ activity.total_meters|meters_to_prefered_distance:user.get_profile.use_imperial }}
            {{user.get_profile.use_imperial|miles_or_km_units}}</td>
        </tr>
        <tr>
          <td>Ascent:</td><td>{{activity.total_ascent|format_meters:user.get_profile.use_imperial}} {{user.get_profile.use_imperial|meters_or_feet_units}}</td>
        </tr>
        <tr>
          <td>Decent:</td>
          <td>{{activity.total_descent|format_meters:user.get_profile.use_imperial}} {{user.get_profile.use_imperial|meters_or_feet_units}}</td>
        </tr>

        <tr>
          <td>Rolling Time:</td><td>{{ activity.rolling_time|seconds_to_human_readable }}</td>
        </tr>
        <tr>
          <td>Total Time:</td><td>{{ activity.total_time|seconds_to_human_readable }}</td>
        </tr>
        <tr>
          <td>Speed:</td>
          <td>
            Avg: {{ activity.average_speed|kph_to_prefered_speed:user.get_profile.use_imperial }} {{user.get_profile.use_imperial|mph_or_kph_units}},
            Max: {{ activity.maximum_speed|kph_to_prefered_speed:user.get_profile.use_imperial }} {{user.get_profile.use_imperial|mph_or_kph_units}}
           </td>
        </tr>
        <tr>
          <td>Heart Rate:</td><td>Avg: {{ activity.average_bpm }}, Max: {{ activity.maximum_bpm }} bpm</td>
        </tr>
        <tr>
          <td>Cadence:</td><td>Avg: {{ activity.average_cadence }}, Max: {{ activity.maximum_cadence }} rpm</td>
        </tr>
        <tr>
          <td>Calories:</td><td>{{ activity.total_calories|floatformat:"-2" }}</td>
        </tr>
        <tr>
          <td>Start Location:</td><td id="start_location"></td>
        </tr>
        <tr>
          <td>Middle Location:</td><td id="mid_location"></td>
        </tr>
        <tr>
          <td>End Location:</td><td id="end_location"></td>
        </tr>
        <tr>
          <td>Uploaded By:</td><td>{{ activity.parent.user }}</td>
        </tr>
        <tr>
          <td>
            Public:</td>
          <td>
            <span id="public_flag">{{ activity.public }}</span>
            <script type="text/javascript">
              $("#public_flag").editInPlace({
                url: "/activity/update/",
                params: "ajax=yes",
                value_required: true,
                field_type: "select",
                select_options: "True, False",
                params: "activity_id={{activity.key}}&attribute=public",
              });
            </script>

          </td>
        </tr>
        <tr>
          <td>Comment:</td>
          <td>
            <span id="editable_comment">{{ activity.comment }}</span>
            <script type="text/javascript">
              $("#editable_comment").editInPlace({
                url: "/activity/update/",
                params: "ajax=yes",
                value_required: true,
                params: "activity_id={{activity.key}}&attribute=comment"
              });
            </script>
          </td>
        </tr>
      </table>
    </td>
    <td>
      <div id="map" style="width: 430px; height: 400px"></div>
      <div>
        <a href="http://maps.google.com/maps?q={{kml_location}}&t=p">Bigger Map</a> -
        <a href="{{kml_location}}">Download KML</a> -
        <a href="/activity/public/{{activity.str_key}}">Public Link</a>
      </div>
    </td>
  </tr>
  <tr>
    <td valign="top">
      Altitude ({{user.get_profile.use_imperial|meters_or_feet_units}}):
      <div id="altitudechart" style="width: 430px; height: 200px"></div>
      Speed ({{user.get_profile.use_imperial|mph_or_kph_units}}):
<div id="speedchart" style="width: 430px; height: 200px"></div>

    </td>
    <td>
      Distance ({{user.get_profile.use_imperial|miles_or_km_units}}):
      <div id="distancechart" style="width: 430px; height: 200px"></div>
      Heart Rate (BPM):
      <div id="bpmchart" style="width: 430px; height: 200px"></div>
      Cadence (RPM):
      <div id="cadencechart" style="width: 430px; height: 200px"></div>
    </td>
  </tr>
</table>
</div>

<br/>


<script id="source" language="javascript" type="text/javascript">
  function onResize() {
    var f = 1;
  }
  function onLoad() {
    var eventSource = new Timeplot.DefaultEventSource();

    var timeGeometry = new Timeplot.DefaultTimeGeometry({
      gridColor: new Timeplot.Color("#000000"),
      axisLabelsPlacement: "top"
    });

    var altitudeGeometry = new Timeplot.DefaultValueGeometry({
      gridColor: "#000000",
      axisLabelsPlacement: "left",
    });
    var speedGeometry = new Timeplot.DefaultValueGeometry({
      gridColor: "#000000",
      axisLabelsPlacement: "left",
    });
    var distanceGeometry = new Timeplot.DefaultValueGeometry({
      gridColor: "#000000",
      axisLabelsPlacement: "left",
    });
    var cadenceGeometry = new Timeplot.DefaultValueGeometry({
      gridColor: "#000000",
      axisLabelsPlacement: "left",
    });
    var bpmGeometry = new Timeplot.DefaultValueGeometry({
      gridColor: "#000000",
      axisLabelsPlacement: "left",
    });

    var altitudeInfo = [
      Timeplot.createPlotInfo({
        id: "plot1",
        dataSource: new Timeplot.Processor(new Timeplot.ColumnSource(eventSource,1), Timeplot.Operator.average, { size: 5 }),
        valueGeometry: altitudeGeometry,
        timeGeometry: timeGeometry,
        lineColor: "#ff0000",
        fillColor: "#cc8080",
        showValues: true
      }),
      ];
    var speedInfo = [
      Timeplot.createPlotInfo({
        id: "plot2",
        dataSource: new Timeplot.Processor(
          new Timeplot.ColumnSource(eventSource,2),
            Timeplot.Operator.average, { size: 15 }),
        valueGeometry: speedGeometry,
        timeGeometry: timeGeometry,
        lineColor: "#D0A825",
        fillColor: "#D0A825",
        showValues: true
      }),
      ];
    var cadenceInfo = [
      Timeplot.createPlotInfo({
        id: "plot3",
        dataSource: new Timeplot.Processor(
          new Timeplot.ColumnSource(eventSource,3),
            Timeplot.Operator.average, { size: 30 }),
        valueGeometry: cadenceGeometry,
        timeGeometry: timeGeometry,
        lineColor: "#ff0000",
        fillColor: "#cc8080",
        showValues: true
      }),
      ];
    var distanceInfo = [
      Timeplot.createPlotInfo({
        id: "plot4",
        dataSource: new Timeplot.ColumnSource(eventSource,4),
        valueGeometry: distanceGeometry,
        timeGeometry: timeGeometry,
        lineColor: "#99B3CC",
        fillColor: "#99B3CC",
        showValues: true
      }),
      ];
    var bpmInfo = [
      Timeplot.createPlotInfo({
        id: "plot5",
        dataSource: new Timeplot.Processor(
          new Timeplot.ColumnSource(eventSource,5),
            Timeplot.Operator.average, { size: 15 }),
        valueGeometry: bpmGeometry,
        timeGeometry: timeGeometry,
        lineColor: "#99B386",
        fillColor: "#99B386",
        showValues: true
      }),
    ];

    altitudeplot = Timeplot.create(document.getElementById("altitudechart"),
        altitudeInfo);
    speedplot = Timeplot.create(document.getElementById("speedchart"),
        speedInfo);
    cadenceplot = Timeplot.create(document.getElementById("cadencechart"),
        cadenceInfo);
    distanceplot = Timeplot.create(document.getElementById("distancechart"),
        distanceInfo);
    bpmplot = Timeplot.create(document.getElementById("bpmchart"),
        bpmInfo);


    altitudeplot.loadText("/activity/data/{{activity.str_key}}", ",", eventSource);
};
</script>


{% endblock %}
